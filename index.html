<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Visualine</title>
    <style>
        /* Reset and base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            padding: 16px;
            margin: 0;
            background: #FFFFFF;
            color: #333;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Header */
        .header {
            margin-bottom: 20px;
            padding-bottom: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
        }

        .logo-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo-svg {
            width: 100%;
            height: 100%;
            max-height: 40px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        button {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #E5E5E5;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            outline: none;
        }

        button:hover:not(:disabled) {
            background: #8cee87;
            border-color: #060101;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        button.primary {
            background: #09bc42;
            color: rgb(1, 0, 0);
            border-color: #000000;
        }

        button.primary:hover:not(:disabled) {
            background: #54ec07;
            border-color: #000000;
        }

        /* Status Area */
        .status-area {
            margin: 12px 0;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
        }

        .status-loading {
            background: #E3F2FD;
            color: #1565C0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-error {
            background: #FFEBEE;
            color: #C62828;
            border: 1px solid #FFCDD2;
        }

        .status-success {
            background: #E8F5E8;
            color: #2E7D32;
            border: 1px solid #C8E6C9;
        }

        /* Spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid #1565C0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stats */
        .stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
            padding: 8px;
            background: #F8F9FA;
            border-radius: 4px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .stat-value {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        /* Results */
        .results {
            margin-top: 16px;
        }

        .result-item {
            border: 1px solid #E5E5E5;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            transition: border-color 0.2s ease;
            background: white;
        }

        .result-item:hover {
            border-color: #007BFF;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
            text-transform: capitalize;
        }

        .badge.widely {
            background: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }

        .badge.limited {
            background: #FFF3CD;
            color: #856404;
            border: 1px solid #FFEEBA;
        }

        .badge.new {
            background: #CCE5FF;
            color: #004085;
            border: 1px solid #B3D7FF;
        }

        .badge.unknown {
            background: #E9ECEF;
            color: #495057;
            border: 1px solid #DEE2E6;
        }

        /* Layer Info */
        .layer-name {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .layer-type {
            font-size: 11px;
            color: #666;
            background: #F5F5F5;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }

        /* Color Info */
        .color-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .color-swatch {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            border: 1px solid #E5E5E5;
            flex-shrink: 0;
        }

        /* Notes */
        .note {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            line-height: 1.4;
            font-style: italic;
        }

        /* Error Items */
        .error-item {
            background: #FFEBEE;
            border: 1px solid #FFCDD2;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .error-header {
            font-weight: 600;
            color: #C62828;
            margin-bottom: 4px;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 0;
            font-size: 13px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #F1F1F1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #C1C1C1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #A8A8A8;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-container">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="250 50 1500 300" width="2000" height="400">
<path d="M0 0 C660 0 1320 0 2000 0 C2000 132 2000 264 2000 400 C1340 400 680 400 0 400 C0 268 0 136 0 0 Z " fill="#C5E9D2" transform="translate(0,0)"/>
<path d="M0 0 C26 0 26 0 31.5 4.625 C32.72644211 6.7160705 33.89147059 8.84410143 35 11 C36.13276876 12.61484023 37.26705044 14.22912003 38.44042969 15.81469727 C39.7261438 17.55222359 40.97252413 19.31326098 42.21484375 21.08203125 C45.3349402 25.49359205 48.53958692 29.84142156 51.75 34.1875 C52.34256592 34.98994141 52.93513184 35.79238281 53.5456543 36.61914062 C54.75867825 38.26110709 55.97197755 39.90287017 57.18554688 41.54443359 C60.12794822 45.52649398 63.06361772 49.51349894 66 53.5 C68.31 56.635 70.62 59.77 73 63 C77.62 69.27 82.24 75.54 87 82 C87.33 54.94 87.66 27.88 88 0 C96.91 0 105.82 0 115 0 C115 42.24 115 84.48 115 128 C89 128 89 128 83.1875 122.625 C81.92797852 120.74194336 81.92797852 120.74194336 81.12890625 119.02734375 C78.76397807 114.38610028 75.7249729 110.35978211 72.625 106.1875 C71.50952305 104.63960078 70.39623924 103.09011873 69.28515625 101.5390625 C66.25992745 97.34263418 63.17631038 93.19347805 60.0625 89.0625 C55.65304643 83.2125224 51.28071726 77.3368528 46.9375 71.4375 C46.40842041 70.71892822 45.87934082 70.00035645 45.33422852 69.26000977 C39.88072522 61.84643533 34.44253146 54.42163381 29 47 C28.67 73.73 28.34 100.46 28 128 C18.76 128 9.52 128 0 128 C0 85.76 0 43.52 0 0 Z " fill="#020202" transform="translate(1103,128)"/>
<path d="M0 0 C10.23 0 20.46 0 31 0 C41.25838419 24.48136131 51.49913297 48.96995129 61.70117188 73.47485352 C62.52864455 75.46240288 63.3561185 77.44995171 64.18359375 79.4375 C64.58710052 80.40674911 64.9906073 81.37599823 65.40634155 82.37461853 C68.13137041 88.91867973 70.8629512 95.45997734 73.59765625 102 C74.64966465 104.51770163 75.70152731 107.0354641 76.75332642 109.55325317 C77.41315712 111.13170301 78.07360976 112.70989303 78.73471069 114.28781128 C79.63198489 116.42951022 80.52716861 118.57207112 81.421875 120.71484375 C82.17355957 122.51103149 82.17355957 122.51103149 82.94042969 124.34350586 C84 127 84 127 84 128 C74.1 128 64.2 128 54 128 C48.555 115.13 48.555 115.13 43 102 C24.85 102 6.7 102 -12 102 C-17.445 114.87 -17.445 114.87 -23 128 C-32.9 128 -42.8 128 -53 128 C-48.56130628 115.91921568 -43.75316736 104.04397063 -38.75 92.1875 C-37.96184049 90.313366 -37.17400559 88.43909546 -36.38647461 86.56469727 C-34.75022874 82.67087841 -33.11259734 78.77764644 -31.47412109 74.88476562 C-29.04420546 69.10862105 -26.62406885 63.32841847 -24.20703125 57.546875 C-23.81882202 56.61831696 -23.43061279 55.68975891 -23.03063965 54.73306274 C-22.25643318 52.88115098 -21.48224275 51.02923251 -20.70806885 49.17730713 C-13.84666268 32.76718077 -6.9466538 16.37425538 0 0 Z " fill="#020202" transform="translate(853,128)"/>
<path d="M0 0 C8.91 0 17.82 0 27 0 C27.01458252 2.37630615 27.02916504 4.7526123 27.04418945 7.20092773 C27.09465782 15.07601578 27.16127424 22.95090863 27.23571491 30.82580471 C27.28033148 35.59763824 27.3196066 40.3693881 27.34643555 45.14135742 C27.37255573 49.75159459 27.41301914 54.36150828 27.46318626 58.97154427 C27.47979625 60.72524029 27.49134691 62.47899218 27.49761391 64.23275566 C27.54359518 75.92346097 28.04879414 85.17243309 35 95 C35 95.66 35 96.32 35 97 C35.53625 97.268125 36.0725 97.53625 36.625 97.8125 C39 99 39 99 41.625 100.625 C46.8200411 102.74149823 51.80439325 102.94851932 57.2109375 101.34375 C64.83491011 97.95531773 69.2273744 91.87918306 72.1661377 84.24420166 C74.00267266 77.09902942 73.60587473 69.63734637 73.609375 62.3046875 C73.62437689 60.50292489 73.64110821 58.70117593 73.65948486 56.89944458 C73.70294532 52.18790003 73.72310992 47.47654092 73.73822021 42.76483154 C73.75786857 37.94467296 73.79982962 33.12471242 73.83984375 28.3046875 C73.91491501 18.86981954 73.96328018 9.43509524 74 0 C82.91 0 91.82 0 101 0 C101.13625222 11.32779991 101.24603075 22.65504416 101.31087303 33.98348236 C101.34201436 39.24532328 101.38416806 44.50656831 101.45263672 49.76806641 C101.51844884 54.85802456 101.55383488 59.94741428 101.56926346 65.0377655 C101.58023996 66.96722852 101.60167035 68.89666499 101.63438034 70.82588196 C101.88025734 85.94674917 100.27221774 100.15943928 89.8984375 112.05078125 C89.27195312 112.69402344 88.64546875 113.33726562 88 114 C87.33226562 114.69480469 86.66453125 115.38960938 85.9765625 116.10546875 C74.98757403 126.67790712 62.16603931 130.45548535 47.29711914 130.43383789 C33.77919529 130.11867685 22.98676525 123.72270793 13.25 114.6875 C0.56210968 101.25326319 -0.58614529 85.85241292 -0.390625 68.359375 C-0.38315067 66.38112972 -0.37746338 64.40287696 -0.37347412 62.42462158 C-0.35831158 57.2558697 -0.31911215 52.08757821 -0.2746582 46.91900635 C-0.23350153 41.62966131 -0.21541982 36.34024078 -0.1953125 31.05078125 C-0.15260744 20.70028757 -0.08233589 10.35025437 0 0 Z " fill="#010101" transform="translate(688,128)"/>
<path d="M0 0 C26.73 0 53.46 0 81 0 C81 8.25 81 16.5 81 25 C63.51 25 46.02 25 28 25 C28 32.59 28 40.18 28 48 C43.18 48 58.36 48 74 48 C74 56.25 74 64.5 74 73 C58.82 73 43.64 73 28 73 C28 82.9 28 92.8 28 103 C45.49 103 62.98 103 81 103 C81 111.25 81 119.5 81 128 C54.27 128 27.54 128 0 128 C0 85.76 0 43.52 0 0 Z " fill="#030303" transform="translate(1235,128)"/>
<path d="M0 0 C10.56348146 8.10685786 10.56348146 8.10685786 11.51953125 13.93359375 C10.73449219 14.45308594 9.94945312 14.97257812 9.140625 15.5078125 C8.09003906 16.20519531 7.03945313 16.90257812 5.95703125 17.62109375 C4.31734375 18.70777344 4.31734375 18.70777344 2.64453125 19.81640625 C0.18614374 21.48196379 -2.18402166 23.19637981 -4.54296875 24.99609375 C-5.51234375 25.63546875 -6.48171875 26.27484375 -7.48046875 26.93359375 C-10.48046875 25.93359375 -10.48046875 25.93359375 -12.66796875 23.62109375 C-18.55619222 17.9945691 -23.43854963 16.57514945 -31.60546875 16.49609375 C-32.28649658 16.48602295 -32.96752441 16.47595215 -33.66918945 16.46557617 C-38.31724134 16.54531523 -41.53448333 17.50440096 -45.48046875 19.93359375 C-49.86444659 24.79151514 -50.70984915 27.39625237 -50.48046875 33.93359375 C-49.82392649 36.99852436 -49.82392649 36.99852436 -47.66943359 37.99951172 C-46.9470752 38.30775879 -46.2247168 38.61600586 -45.48046875 38.93359375 C-44.83674316 39.25344238 -44.19301758 39.57329102 -43.52978516 39.90283203 C-37.46262082 42.75990188 -31.37620837 44.32625285 -24.85546875 45.80859375 C5.75370452 53.1843545 5.75370452 53.1843545 14.58203125 67.24609375 C18.26092447 75.51398967 17.98178028 86.38544313 15.703125 95.03125 C10.55494805 106.35006413 0.82209512 114.70597205 -10.60546875 119.1484375 C-25.83540934 124.39306165 -42.7659252 125.26617369 -57.85546875 118.9375 C-67.32466812 114.18646073 -75.5968372 106.35846203 -80.48046875 96.93359375 C-80.83388074 95.60544133 -81.17023048 94.27248923 -81.48046875 92.93359375 C-77.52494772 91.09414749 -73.5656059 89.26307822 -69.60546875 87.43359375 C-68.47753906 86.90894531 -67.34960938 86.38429688 -66.1875 85.84375 C-64.57294922 85.09931641 -64.57294922 85.09931641 -62.92578125 84.33984375 C-61.93078613 83.87900391 -60.93579102 83.41816406 -59.91064453 82.94335938 C-57.48046875 81.93359375 -57.48046875 81.93359375 -55.48046875 81.93359375 C-55.08859375 82.98546875 -54.69671875 84.03734375 -54.29296875 85.12109375 C-52.07421833 90.20573012 -48.96137644 93.50116501 -43.85546875 95.74609375 C-34.79251233 98.70473243 -25.87764168 97.17473346 -17.48046875 92.93359375 C-14.69728517 90.76544404 -13.95443461 89.03039364 -13.48046875 85.55859375 C-13.29484375 84.43324219 -13.29484375 84.43324219 -13.10546875 83.28515625 C-13.70880754 79.50171927 -15.49628998 78.25672026 -18.48046875 75.93359375 C-21.52824739 74.60391849 -24.64773983 73.73139375 -27.85546875 72.87109375 C-29.1868689 72.49005493 -29.1868689 72.49005493 -30.54516602 72.10131836 C-34.56947428 70.96005336 -38.60470927 69.88754485 -42.671875 68.91015625 C-56.68404889 65.49112738 -68.03774706 60.26764592 -75.8515625 47.734375 C-79.72147156 39.8472593 -80.33398672 29.39339471 -77.90478516 20.92724609 C-73.39302747 8.85391767 -64.9582971 0.47574516 -53.48046875 -5.06640625 C-35.91747255 -12.79220512 -15.76919008 -10.73597861 0 0 Z " fill="#020202" transform="translate(657.48046875,135.06640625)"/>
<path d="M0 0 C9.9 0 19.8 0 30 0 C42.83075911 30.93462974 55.49611892 61.93180199 68 93 C70.07085628 90.92914372 70.70949686 89.61598718 71.79321289 86.94140625 C72.13919022 86.09465836 72.48516754 85.24791046 72.84162903 84.37550354 C73.21486801 83.44721237 73.58810699 82.5189212 73.97265625 81.5625 C74.36817184 80.59034042 74.76368744 79.61818085 75.17118835 78.61656189 C76.47313521 75.41298308 77.76784771 72.20653288 79.0625 69 C79.95757121 66.79352401 80.85308282 64.58722662 81.74902344 62.38110352 C84.0515141 56.70801936 86.34794137 51.03250225 88.64263916 45.35626221 C90.79386719 40.0370537 92.94988915 34.71978991 95.10546875 29.40234375 C99.07639569 19.6040154 103.03992684 9.80271996 107 0 C116.9 0 126.8 0 137 0 C133.62953909 11.23486972 133.62953909 11.23486972 131.49609375 16.02734375 C131.01253418 17.12570557 130.52897461 18.22406738 130.03076172 19.35571289 C129.50498535 20.53770264 128.97920898 21.71969238 128.4375 22.9375 C127.25712193 25.62039152 126.0829523 28.305974 124.91015625 30.9921875 C124.59812256 31.70627274 124.28608887 32.42035797 123.96459961 33.15608215 C120.00259661 42.24989077 116.19295542 51.40753406 112.375 60.5625 C110.85457845 64.20590115 109.33370058 67.84911155 107.8125 71.4921875 C107.42698471 72.41555908 107.04146942 73.33893066 106.64427185 74.2902832 C101.91804477 85.6020792 97.14701676 96.89496283 92.375 108.1875 C91.95128113 109.19032013 91.52756226 110.19314026 91.09100342 111.22634888 C88.72825522 116.81795549 86.36429442 122.40904657 84 128 C73.77 128 63.54 128 53 128 C51.92105469 125.41800781 50.84210938 122.83601563 49.73046875 120.17578125 C41.64419028 100.8327066 33.53438701 81.49985768 25.375 62.1875 C24.58705162 60.32162523 23.79912839 58.45573983 23.01123047 56.58984375 C19.48612125 48.2431699 15.95786164 39.89786254 12.4196167 31.55674744 C10.90634463 27.98778416 9.39580846 24.41766705 7.88580322 20.84732056 C7.17516562 19.16900751 6.4632287 17.49124399 5.74993896 15.8140564 C4.77408879 13.51931042 3.80255932 11.22278207 2.83203125 8.92578125 C2.54243027 8.24790558 2.25282928 7.57002991 1.95445251 6.87161255 C0 2.22791732 0 2.22791732 0 0 Z " fill="#010201" transform="translate(364,128)"/>
<path d="M0 0 C8.91 0 17.82 0 27 0 C27 33.99 27 67.98 27 103 C44.49 103 61.98 103 80 103 C80 111.25 80 119.5 80 128 C53.6 128 27.2 128 0 128 C0 85.76 0 43.52 0 0 Z " fill="#010101" transform="translate(950,128)"/>
<path d="M0 0 C15.51 0 31.02 0 47 0 C47 7.59 47 15.18 47 23 C43.7 23 40.4 23 37 23 C37 50.06 37 77.12 37 105 C40.3 105 43.6 105 47 105 C47 112.59 47 120.18 47 128 C31.49 128 15.98 128 0 128 C0 120.41 0 112.82 0 105 C3.3 105 6.6 105 10 105 C10 77.94 10 50.88 10 23 C6.7 23 3.4 23 0 23 C0 15.41 0 7.82 0 0 Z " fill="#000100" transform="translate(1040,128)"/>
<path d="M0 0 C15.51 0 31.02 0 47 0 C47 7.59 47 15.18 47 23 C43.7 23 40.4 23 37 23 C37 50.06 37 77.12 37 105 C40.3 105 43.6 105 47 105 C47 112.59 47 120.18 47 128 C31.49 128 15.98 128 0 128 C0 120.41 0 112.82 0 105 C3.3 105 6.6 105 10 105 C10 77.94 10 50.88 10 23 C6.7 23 3.4 23 0 23 C0 15.41 0 7.82 0 0 Z " fill="#000100" transform="translate(514,128)"/>
<path d="M0 0 C82.83 0 165.66 0 251 0 C251 4.62 251 9.24 251 14 C168.17 14 85.34 14 0 14 C0 9.38 0 4.76 0 0 Z " fill="#23A548" transform="translate(1406,240)"/>
<path d="M0 0 C82.83 0 165.66 0 251 0 C251 4.62 251 9.24 251 14 C168.17 14 85.34 14 0 14 C0 9.38 0 4.76 0 0 Z " fill="#23A548" transform="translate(1359,193)"/>
<path d="M0 0 C82.83 0 165.66 0 251 0 C251 4.62 251 9.24 251 14 C168.17 14 85.34 14 0 14 C0 9.38 0 4.76 0 0 Z " fill="#23A548" transform="translate(1406,148)"/>
<path d="M0 0 C3.36904459 1.68452229 4.10082568 5.52125429 5.4765625 8.8671875 C5.80667328 9.65771515 6.13678406 10.4482428 6.47689819 11.26272583 C7.17439038 12.93762795 7.86852258 14.6139326 8.55957031 16.29150391 C9.6192097 18.86095944 10.6915651 21.42482544 11.765625 23.98828125 C12.44087309 25.61426422 13.11537714 27.24055643 13.7890625 28.8671875 C14.11089508 29.63602264 14.43272766 30.40485779 14.76431274 31.19699097 C17 36.65423161 17 36.65423161 17 40 C6.11 40 -4.78 40 -16 40 C-15.07786473 35.38932364 -13.66852549 31.41216293 -11.875 27.109375 C-11.41456299 25.99154633 -11.41456299 25.99154633 -10.94482422 24.85113525 C-10.29805406 23.28365472 -9.64908437 21.71708014 -8.99804688 20.15136719 C-7.99848118 17.74634562 -7.00653531 15.33828633 -6.015625 12.9296875 C-5.38586193 11.40606588 -4.75566869 9.88262198 -4.125 8.359375 C-3.82706543 7.63651306 -3.52913086 6.91365112 -3.22216797 6.16888428 C-1.11586085 1.11586085 -1.11586085 1.11586085 0 0 Z " fill="#BDDFC9" transform="translate(868,164)"/>
</svg>
        </div>
    </div>

    <div class="controls">
        <button id="scanSelected" class="primary">Scan Selection</button>
        <button id="scanAll">Scan All</button>
    </div>

    <div id="statusArea" class="hidden"></div>
    <div id="stats" class="stats hidden"></div>

    <div id="results" class="results">
        <div id="emptyState" class="empty-state">
            Click "Scan Selection" to analyze design tokens
        </div>
    </div>

    <script>
        // DOM elements
        const scanSelectedBtn = document.getElementById('scanSelected');
        const scanAllBtn = document.getElementById('scanAll');
        const statusArea = document.getElementById('statusArea');
        const statsElement = document.getElementById('stats');
        const resultsElement = document.getElementById('results');
        const emptyState = document.getElementById('emptyState');

        // Initialize the plugin
        function initializePlugin() {
            setupEventListeners();
            resizeWindow(340, 500); // Initial size
        }

        // Set up event listeners
        function setupEventListeners() {
            scanSelectedBtn.addEventListener('click', () => {
                startScan(true);
            });

            scanAllBtn.addEventListener('click', () => {
                startScan(false);
            });
        }

        // Message handling from Figma
        window.onmessage = (event) => {
            const message = event.data.pluginMessage;
            
            if (!message) return;
            
            switch (message.type) {
                case 'scan-started':
                    showLoading('Starting scan...');
                    break;
                    
                case 'scan-progress':
                    showLoading(`Scanning... (${message.processed}/${message.total} layers)`);
                    break;
                    
                case 'scan-results':
                    showResults(message.results, message.stats, message.errors);
                    break;
                    
                case 'scan-error':
                    showError(message.message);
                    break;
            }
        };

        // Start the scanning process
        function startScan(selectedOnly) {
            // Reset UI
            clearStatus();
            hideResults();
            setButtonsDisabled(true);
            
            // Send message to plugin
            parent.postMessage({ 
                pluginMessage: { 
                    type: 'scan-selection', 
                    selectedOnly: selectedOnly 
                } 
            }, '*');
        }

        // Show loading state
        function showLoading(message) {
            statusArea.innerHTML = `
                <div class="status-area status-loading">
                    <div class="spinner"></div>
                    <span>${escapeHtml(message)}</span>
                </div>
            `;
            statusArea.classList.remove('hidden');
        }

        // Show results
        function showResults(results, stats, errors) {
            setButtonsDisabled(false);
            clearStatus();
            
            // Show stats
            if (stats) {
                showStats(stats);
            }
            
            // Show errors if any
            if (errors && errors.length > 0) {
                showErrors(errors);
            }
            
            // Show results
            if (results.length === 0) {
                showEmptyState();
            } else {
                hideEmptyState();
                resultsElement.innerHTML = results.map(result => createResultHTML(result)).join('');
                
                // Resize window based on content
                const estimatedHeight = 200 + (results.length * 120) + (errors ? errors.length * 80 : 0);
                const maxHeight = 600;
                resizeWindow(340, Math.min(estimatedHeight, maxHeight));
            }
        }

        // Show statistics
        function showStats(stats) {
            statsElement.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${stats.totalNodes}</div>
                    <div>Layers</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.colorMatches}</div>
                    <div>Colors</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.errorCount}</div>
                    <div>Errors</div>
                </div>
            `;
            statsElement.classList.remove('hidden');
        }

        // Show errors
        function showErrors(errors) {
            const errorsHTML = errors.map(error => `
                <div class="error-item">
                    <div class="error-header">${escapeHtml(error.nodeName)} (${error.nodeType})</div>
                    <div>${escapeHtml(error.error)}</div>
                </div>
            `).join('');
            
            statusArea.innerHTML = `
                <div class="status-area status-error">
                    <strong>${errors.length} error(s) occurred during scan:</strong>
                    <div style="margin-top: 8px;">${errorsHTML}</div>
                </div>
            `;
            statusArea.classList.remove('hidden');
        }

        // Show error message
        function showError(message) {
            setButtonsDisabled(false);
            statusArea.innerHTML = `
                <div class="status-area status-error">
                    ${escapeHtml(message)}
                </div>
            `;
            statusArea.classList.remove('hidden');
        }

        // Create HTML for a single result item
        function createResultHTML(result) {
            return `
                <div class="result-item">
                    <div class="layer-name">
                        ${escapeHtml(result.layerName)}
                        <span class="layer-type">${result.layerType}</span>
                    </div>
                    <div class="color-info">
                        <div class="color-swatch" style="background-color: ${result.color};"></div>
                        <span>${result.color}</span>
                        <span class="badge ${result.tokenMatch.availability}">
                            ${getAvailabilityIcon(result.tokenMatch.availability)} ${result.tokenMatch.availability}
                        </span>
                    </div>
                    <div><strong>Token:</strong> ${escapeHtml(result.tokenMatch.name)}</div>
                    <div><strong>Style:</strong> ${result.styleType}</div>
                    ${result.tokenMatch.distance !== null ? 
                        `<div><strong>Match distance:</strong> ${result.tokenMatch.distance.toFixed(2)}</div>` : ''}
                    <div class="note">${escapeHtml(result.tokenMatch.note)}</div>
                </div>
            `;
        }

        // Clear status area
        function clearStatus() {
            statusArea.innerHTML = '';
            statusArea.classList.add('hidden');
        }

        // Hide results
        function hideResults() {
            statsElement.classList.add('hidden');
            showEmptyState();
        }

        // Show empty state
        function showEmptyState() {
            emptyState.style.display = 'block';
            resultsElement.innerHTML = '';
        }

        // Hide empty state
        function hideEmptyState() {
            emptyState.style.display = 'none';
        }

        // Set buttons disabled state
        function setButtonsDisabled(disabled) {
            scanSelectedBtn.disabled = disabled;
            scanAllBtn.disabled = disabled;
        }

        // Resize plugin window
        function resizeWindow(width, height) {
            parent.postMessage({
                pluginMessage: {
                    type: 'resize-window',
                    width: width,
                    height: height
                }
            }, '*');
        }

        // Get availability icon
        function getAvailabilityIcon(availability) {
            const icons = {
                'widely': '‚úÖ',
                'limited': '‚ö†Ô∏è',
                'new': 'üÜï',
                'unknown': '‚ùì'
            };
            return icons[availability] || '‚ùì';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return String(unsafe);
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Initialize the plugin when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializePlugin);
    </script>
</body>
</html>