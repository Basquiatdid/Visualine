<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Visualine</title>
    <style>
        /* Reset and base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            padding: 16px;
            margin: 0;
            background: #FFFFFF;
            color: #333;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Header */
        .header {
            margin-bottom: 20px;
            border-bottom: 1px solid #E5E5E5;
            padding-bottom: 12px;
        }

        .header h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .header p {
            margin: 0;
            color: #666;
            font-size: 12px;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        button {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #E5E5E5;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            outline: none;
        }

        button:hover:not(:disabled) {
            background: #F5F5F5;
            border-color: #CCCCCC;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        button.primary {
            background: #007BFF;
            color: white;
            border-color: #007BFF;
        }

        button.primary:hover:not(:disabled) {
            background: #0056CC;
            border-color: #0056CC;
        }

        /* Status Area */
        .status-area {
            margin: 12px 0;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
        }

        .status-loading {
            background: #E3F2FD;
            color: #1565C0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-error {
            background: #FFEBEE;
            color: #C62828;
            border: 1px solid #FFCDD2;
        }

        .status-success {
            background: #E8F5E8;
            color: #2E7D32;
            border: 1px solid #C8E6C9;
        }

        /* Spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid #1565C0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stats */
        .stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: #666;
            margin-bottom: 12px;
            padding: 8px;
            background: #F8F9FA;
            border-radius: 4px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .stat-value {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        /* Results */
        .results {
            margin-top: 16px;
        }

        .result-item {
            border: 1px solid #E5E5E5;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            transition: border-color 0.2s ease;
            background: white;
        }

        .result-item:hover {
            border-color: #007BFF;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
            text-transform: capitalize;
        }

        .badge.widely {
            background: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }

        .badge.limited {
            background: #FFF3CD;
            color: #856404;
            border: 1px solid #FFEEBA;
        }

        .badge.new {
            background: #CCE5FF;
            color: #004085;
            border: 1px solid #B3D7FF;
        }

        .badge.unknown {
            background: #E9ECEF;
            color: #495057;
            border: 1px solid #DEE2E6;
        }

        /* Layer Info */
        .layer-name {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .layer-type {
            font-size: 11px;
            color: #666;
            background: #F5F5F5;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 500;
        }

        /* Color Info */
        .color-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .color-swatch {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            border: 1px solid #E5E5E5;
            flex-shrink: 0;
        }

        /* Notes */
        .note {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            line-height: 1.4;
            font-style: italic;
        }

        /* Error Items */
        .error-item {
            background: #FFEBEE;
            border: 1px solid #FFCDD2;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .error-header {
            font-weight: 600;
            color: #C62828;
            margin-bottom: 4px;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 0;
            font-size: 13px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #F1F1F1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: #C1C1C1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #A8A8A8;
        }
    </style>
</head>
<body>
    <div class="header">
        <h3>Visualine</h3>
        <p>Scan design tokens for browser compatibility</p>
    </div>

    <div class="controls">
        <button id="scanSelected" class="primary">Scan Selection</button>
        <button id="scanAll">Scan All</button>
    </div>

    <div id="statusArea" class="hidden"></div>
    <div id="stats" class="stats hidden"></div>

    <div id="results" class="results">
        <div id="emptyState" class="empty-state">
            Click "Scan Selection" to analyze design tokens
        </div>
    </div>

    <script>
        // DOM elements
        const scanSelectedBtn = document.getElementById('scanSelected');
        const scanAllBtn = document.getElementById('scanAll');
        const statusArea = document.getElementById('statusArea');
        const statsElement = document.getElementById('stats');
        const resultsElement = document.getElementById('results');
        const emptyState = document.getElementById('emptyState');

        // Initialize the plugin
        function initializePlugin() {
            setupEventListeners();
            resizeWindow(340, 500); // Initial size
        }

        // Set up event listeners
        function setupEventListeners() {
            scanSelectedBtn.addEventListener('click', () => {
                startScan(true);
            });

            scanAllBtn.addEventListener('click', () => {
                startScan(false);
            });
        }

        // Message handling from Figma
        window.onmessage = (event) => {
            const message = event.data.pluginMessage;
            
            if (!message) return;
            
            switch (message.type) {
                case 'scan-started':
                    showLoading('Starting scan...');
                    break;
                    
                case 'scan-progress':
                    showLoading(`Scanning... (${message.processed}/${message.total} layers)`);
                    break;
                    
                case 'scan-results':
                    showResults(message.results, message.stats, message.errors);
                    break;
                    
                case 'scan-error':
                    showError(message.message);
                    break;
            }
        };

        // Start the scanning process
        function startScan(selectedOnly) {
            // Reset UI
            clearStatus();
            hideResults();
            setButtonsDisabled(true);
            
            // Send message to plugin
            parent.postMessage({ 
                pluginMessage: { 
                    type: 'scan-selection', 
                    selectedOnly: selectedOnly 
                } 
            }, '*');
        }

        // Show loading state
        function showLoading(message) {
            statusArea.innerHTML = `
                <div class="status-area status-loading">
                    <div class="spinner"></div>
                    <span>${escapeHtml(message)}</span>
                </div>
            `;
            statusArea.classList.remove('hidden');
        }

        // Show results
        function showResults(results, stats, errors) {
            setButtonsDisabled(false);
            clearStatus();
            
            // Show stats
            if (stats) {
                showStats(stats);
            }
            
            // Show errors if any
            if (errors && errors.length > 0) {
                showErrors(errors);
            }
            
            // Show results
            if (results.length === 0) {
                showEmptyState();
            } else {
                hideEmptyState();
                resultsElement.innerHTML = results.map(result => createResultHTML(result)).join('');
                
                // Resize window based on content
                const estimatedHeight = 200 + (results.length * 120) + (errors ? errors.length * 80 : 0);
                const maxHeight = 600;
                resizeWindow(340, Math.min(estimatedHeight, maxHeight));
            }
        }

        // Show statistics
        function showStats(stats) {
            statsElement.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${stats.totalNodes}</div>
                    <div>Layers</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.colorMatches}</div>
                    <div>Colors</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.errorCount}</div>
                    <div>Errors</div>
                </div>
            `;
            statsElement.classList.remove('hidden');
        }

        // Show errors
        function showErrors(errors) {
            const errorsHTML = errors.map(error => `
                <div class="error-item">
                    <div class="error-header">${escapeHtml(error.nodeName)} (${error.nodeType})</div>
                    <div>${escapeHtml(error.error)}</div>
                </div>
            `).join('');
            
            statusArea.innerHTML = `
                <div class="status-area status-error">
                    <strong>${errors.length} error(s) occurred during scan:</strong>
                    <div style="margin-top: 8px;">${errorsHTML}</div>
                </div>
            `;
            statusArea.classList.remove('hidden');
        }

        // Show error message
        function showError(message) {
            setButtonsDisabled(false);
            statusArea.innerHTML = `
                <div class="status-area status-error">
                    ${escapeHtml(message)}
                </div>
            `;
            statusArea.classList.remove('hidden');
        }

        // Create HTML for a single result item
        function createResultHTML(result) {
            return `
                <div class="result-item">
                    <div class="layer-name">
                        ${escapeHtml(result.layerName)}
                        <span class="layer-type">${result.layerType}</span>
                    </div>
                    <div class="color-info">
                        <div class="color-swatch" style="background-color: ${result.color};"></div>
                        <span>${result.color}</span>
                        <span class="badge ${result.tokenMatch.availability}">
                            ${getAvailabilityIcon(result.tokenMatch.availability)} ${result.tokenMatch.availability}
                        </span>
                    </div>
                    <div><strong>Token:</strong> ${escapeHtml(result.tokenMatch.name)}</div>
                    <div><strong>Style:</strong> ${result.styleType}</div>
                    ${result.tokenMatch.distance !== null ? 
                        `<div><strong>Match distance:</strong> ${result.tokenMatch.distance.toFixed(2)}</div>` : ''}
                    <div class="note">${escapeHtml(result.tokenMatch.note)}</div>
                </div>
            `;
        }

        // Clear status area
        function clearStatus() {
            statusArea.innerHTML = '';
            statusArea.classList.add('hidden');
        }

        // Hide results
        function hideResults() {
            statsElement.classList.add('hidden');
            showEmptyState();
        }

        // Show empty state
        function showEmptyState() {
            emptyState.style.display = 'block';
            resultsElement.innerHTML = '';
        }

        // Hide empty state
        function hideEmptyState() {
            emptyState.style.display = 'none';
        }

        // Set buttons disabled state
        function setButtonsDisabled(disabled) {
            scanSelectedBtn.disabled = disabled;
            scanAllBtn.disabled = disabled;
        }

        // Resize plugin window
        function resizeWindow(width, height) {
            parent.postMessage({
                pluginMessage: {
                    type: 'resize-window',
                    width: width,
                    height: height
                }
            }, '*');
        }

        // Get availability icon
        function getAvailabilityIcon(availability) {
            const icons = {
                'widely': '✅',
                'limited': '⚠️',
                'new': '🆕',
                'unknown': '❓'
            };
            return icons[availability] || '❓';
        }

        // Escape HTML to prevent XSS
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return String(unsafe);
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Initialize the plugin when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializePlugin);
    </script>
</body>
</html>